version: "3.9"

services:
  api:
    build: .
    image: airqualitymanager-api:latest
    container_name: aqm-api
    restart: unless-stopped
    env_file: ./.env
    expose:
      - "3000"
    networks: [aqm]

  nginx:
    image: nginx:1.27-alpine
    container_name: aqm-nginx
    restart: unless-stopped
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - letsencrypt:/etc/letsencrypt
      - webroot:/var/www/certbot
    networks: [aqm]

  certbot:
    image: certbot/certbot:latest
    container_name: aqm-certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - webroot:/var/www/certbot
    entrypoint: sh -c
    command: >
      "trap exit TERM;
       while :; do
         certbot renew --webroot -w /var/www/certbot --quiet;
         sleep 12h;
       done"
    networks: [aqm]

volumes:
  letsencrypt:
  webroot:

networks:
  aqm:
